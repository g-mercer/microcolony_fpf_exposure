---
title: "Degradation Model Ggplots"
author: "Guy Mercer"
date: "25/08/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

Something to consider is the parms function returns degradation model parameters as well as error model parameters, in order to avoid working with a fitted model without considering the error structure that was assumed for the fit.

What is this error structure? Does it relate to the error level required to pass a chi-squared test? Why is error assumed when I have 3 replicates for all time measurements?

```{r}
library("mkin", quietly = TRUE)
library(tidyverse)

# degradation model plot function

# rwrap function allows an interval of x to be defined to draw the SFO line
rwrap=function(f,xmin,xmax){ff=function(x){y=f(x);y[x>xmax]=NA;y[x<xmin]=NA;y}}

# function
degradation_plot_function <- function(dataframe, model_prediction, input_colour, x_min_line, title) {
  
ggplot(data = dataframe, aes(x = t, y = parent)) +
    
xlab("Time") +
    
ylab("Residue Measurements (Âµg/kg)") +

geom_point(color = input_colour, alpha = 0.7) +

stat_function(fun = rwrap(model_prediction, x_min_line, 240), colour = input_colour, alpha = 0.7) +

theme_bw() +
    
ggtitle(title) +
  
theme(legend.position = "none", axis.title = element_text(size=8, face = "bold"), plot.title = element_text(hjust = 0.5, size = 8, face = "bold")) +
    
scale_x_continuous(limits = c(0, NA), breaks=seq(0,240,24)) # starts axis at 0 and defines ticks

}

# load raw residue data
nectar <- read.csv(file = "./input/nectar_residues_ugkg.csv")

# inputs for all data nectar plot
nectar_total <- nectar [nectar$DALA_h > 0,]

colnames(nectar_total) <- c("t", "parent")

# convert data for mkin
nectar_model_data_total <- mkin_wide_to_long(nectar_total)

# used to output parameters and residuals to be used in creating ggplots
nectar_model_total <- mkinfit("SFO", nectar_model_data_total, quiet = TRUE)

nectar_total_parms <- parms(nectar_model_total)

sfo_line_total <- function(x) {as.numeric(nectar_total_parms [1]) * exp(-as.numeric(nectar_total_parms [2]) * x)}

# colour
colour <- "#E66100"
colour_lines <- "#5D3A9B"

nectar_total_plot <- degradation_plot_function(dataframe = nectar_total, model_prediction = sfo_line_total, input_colour = colour, x_min_line = 0, title = expression(paste("Full Dataset - SFO  ", chi, "2 Error Level = 31.8%")))

nectar_total_plot <- nectar_total_plot + theme(axis.title.x = element_blank())

# add worst case exposure regime onto plot

# means of data 
mean_pre_24h <- mean(nectar_total$parent [nectar_total$t < 24])

mean_24h <- mean(nectar_total$parent [nectar_total$t == 24])

mean_post_24h <- mean(nectar_total$parent [nectar_total$t > 24])

nectar_total_plot <- nectar_total_plot + geom_segment(aes(x=0,xend=24,y=mean_pre_24h,yend=mean_pre_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame()) # this weird solution is because the segment is drawn nrow(dataframe) times. What is done here is using an empty                                       dataframe to get round this unwanted behaviour link:                                                                                                 (https://stackoverflow.com/questions/48397603/alpha-in-geom-segment-not-working). 

# adding step line onto graph
nectar_total_plot <- nectar_total_plot + geom_segment(aes(x=24,xend=48,y=mean_24h,yend=mean_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

nectar_total_plot <- nectar_total_plot + geom_segment(aes(x=48,xend=240,y=mean_post_24h,yend=mean_post_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

nectar_total_plot <- nectar_total_plot + geom_segment(aes(x=24,xend=24,y=mean_pre_24h,yend=mean_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

nectar_total_plot <- nectar_total_plot + geom_segment(aes(x=48,xend=48,y=mean_24h,yend=mean_post_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

nectar_total_plot

# inputs for nectar plot >=24h

# residue measurements
nectar_day_24 <- nectar [nectar$DALA_h > 23,]

colnames(nectar_day_24) <- c("t", "parent")

# convert data for mkin
nectar_model_data_24 <- mkin_wide_to_long(nectar_day_24)

# colour
colour <- "#E66100"
colour_lines <- "#5D3A9B"

# parameters and residuals to be used in creating ggplots
nectar_model_24 <- mkinfit("SFO", nectar_model_data_24, quiet = TRUE)

nectar_model_24_parms <- parms(nectar_model_24)

# from parms = parent_0 * exp(-k_parent * t)
sfo_line_24 <- function(x) {1.274594e+03 * exp(-0.02398272 * x)}

# degradation plot for >=24h
nectar_day_1_plot <- degradation_plot_function(dataframe = nectar_day_24, model_prediction = sfo_line_24, input_colour = colour, x_min_line = 24, title = expression(paste("Reduced Dataset (>23h) - SFO  ", chi, "2 Error Level = 22.1%")))

# add more conservative exposure regime onto plot
nectar_day_1_plot <- nectar_day_1_plot + geom_segment(aes(x=0,xend=24,y=mean_24h,yend=mean_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

nectar_day_1_plot <- nectar_day_1_plot + geom_segment(aes(x=24,xend=240,y=mean_post_24h,yend=mean_post_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

nectar_day_1_plot <- nectar_day_1_plot + geom_segment(aes(x=24,xend=24,y=mean_24h,yend=mean_post_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

nectar_day_1_plot

```

```{r}
# model residual plot function 

# function for res plot

residual_plot_function <- function(dataframe, input_colour) {
  
ggplot(data = dataframe, aes(x = Time, y = Residuals)) +
  
geom_point(color=input_colour, alpha = 0.7) +
  
theme_bw() +
  
geom_hline(aes(yintercept = 0), linetype = "dotted") +
  
theme(legend.position = "none", axis.title = element_text(size=8, face = "bold"), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +

scale_x_continuous(limits = c(0, NA), breaks=seq(0,240,24)) 

}

# input for >=24h nectar residual plot
nectar_model_24_res <- residuals(nectar_model_24)

time <- rep(seq(24,240,by=24), each = 3) # careful with this when doing pollen. Missing 48h values. 

residuals_time_24 <- as.data.frame(cbind(time, nectar_model_24_res))

colnames(residuals_time_24) <- c("Time", "Residuals")

colour <- "#E66100"

# residual plot for >=24h nectar
residuals_nectar_day_1_plot <- residual_plot_function(dataframe = residuals_time_24, input_colour = colour)

residuals_nectar_day_1_plot

# input for total nectar residual plot
residuals_nectar_total <- residuals(nectar_model_total)

time <- rep(seq(24,240,by=24), each = 3) # careful with this when doing pollen. Missing 48h values. 

time <- c(rep(c(1, 2.5, 4), each = 3), time) # for total have to add 1,2.5 and 4h. 

residuals_time_total <- as.data.frame(cbind(time, residuals_nectar_total))

colnames(residuals_time_total) <- c("Time", "Residuals")

colour <- "#E66100"

# residual plot for total nectar
residuals_nectar_total_plot <- residual_plot_function(dataframe = residuals_time_total, input_colour = colour)

residuals_nectar_total_plot <- residuals_nectar_total_plot + theme(axis.title.x = element_blank())

residuals_nectar_total_plot
```
To do. Add error values, do the same as above for pollen, accounting for difference in timepoints and use cowplot to put together. Colour using colourblind friendly palatte. 

```{r}
# import pollen data
pollen <- read.csv(file = "./input/pollen_residues_ugkg.csv")

# filter to remove readings before insecticide application
pollen_total <- pollen [pollen$DALA_h > 0,]

# rename columns so mkin can function
colnames(pollen_total) <- c("t", "parent")

# put data in correct format for mkin
pollen_model_data_total <- mkin_wide_to_long(pollen_total)

# used to output parameters and residuals to be used in creating ggplots
pollen_model_total <- mkinfit("SFO", pollen_model_data_total, quiet = TRUE)

pollen_total_parms <- parms(pollen_model_total)

sfo_line_total_pollen <- function(x) {as.numeric(pollen_total_parms [1]) * exp(-as.numeric(pollen_total_parms [2]) * x)}

colour <- "#1A85FF"
colour_lines <- "#D41159"

pollen_total_plot <- degradation_plot_function(dataframe = pollen_total, model_prediction = sfo_line_total_pollen, input_colour = colour, x_min_line = 0, title = expression(paste("Full Dataset - SFO  ", chi, "2 Error Level = 130%")))

# means of data 
pollen_mean_pre_24h <- mean(pollen_total$parent [pollen_total$t < 24])

pollen_mean_24h <- mean(pollen_total$parent [pollen_total$t == 24])

pollen_mean_post_24h <- mean(pollen_total$parent [pollen_total$t > 24])

# add worst case exposure onto plots
pollen_total_plot <- pollen_total_plot + geom_segment(aes(x=0,xend=24,y=pollen_mean_pre_24h,yend=pollen_mean_pre_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame()) # this weird solution is because the segment is drawn nrow(dataframe) times. What is done here is using an empty                                       dataframe to get round this unwanted behaviour link:                                                                                                 (https://stackoverflow.com/questions/48397603/alpha-in-geom-segment-not-working). 

pollen_total_plot <- pollen_total_plot + geom_segment(aes(x=24,xend=48,y=pollen_mean_24h,yend=pollen_mean_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

pollen_total_plot <- pollen_total_plot + geom_segment(aes(x=48,xend=240,y=pollen_mean_post_24h,yend=pollen_mean_post_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

pollen_total_plot <- pollen_total_plot + geom_segment(aes(x=24,xend=24,y=pollen_mean_pre_24h,yend=pollen_mean_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

pollen_total_plot <- pollen_total_plot + geom_segment(aes(x=48,xend=48,y=pollen_mean_24h,yend=pollen_mean_post_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

pollen_total_plot

# inputs for pollen plot >=24h

# residue measurements
pollen_day_24 <- pollen [pollen$DALA_h > 23,]

colnames(pollen_day_24) <- c("t", "parent")

# convert data for mkin
pollen_model_data_24 <- mkin_wide_to_long(pollen_day_24)

# colour
colour <- "#1A85FF"
colour_lines <- "#D41159"

# parameters and residuals to be used in creating ggplots
pollen_model_24 <- mkinfit("SFO", pollen_model_data_24, quiet = TRUE)

pollen_model_24_parms <- parms(pollen_model_24) #     parent_0     k_parent        sigma 1.763779e+03 4.291755e-42 3.345533e+03 

# from parms = parent_0 * exp(-k_parent * t)
sfo_line_pollen_24 <- function(x) {as.numeric(pollen_model_24_parms [1]) * exp(-as.numeric(pollen_model_24_parms [2]) * x)}

# degradation plot for >=24h
pollen_day_1_plot <- degradation_plot_function(dataframe = pollen_total, model_prediction = sfo_line_24, input_colour = colour, x_min_line = 24, title = expression(paste("Reduced Dataset (>23h) - SFO  ", chi, "2 Error Level = 138%")))

# add more conservative exposure regime onto plot
pollen_day_1_plot <- pollen_day_1_plot + geom_segment(aes(x=0,xend=24,y=pollen_mean_24h,yend=pollen_mean_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

pollen_day_1_plot <- pollen_day_1_plot + geom_segment(aes(x=24,xend=240,y=pollen_mean_post_24h,yend=pollen_mean_post_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

pollen_day_1_plot <- pollen_day_1_plot + geom_segment(aes(x=24,xend=24,y=pollen_mean_24h,yend=pollen_mean_post_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

pollen_day_1_plot
```
Pollen residual plots are pointless as the model failed to fit. Now present these plots together in cowplot:

[Cowplot Vignettes](https://wilkelab.org/cowplot/articles/index.html)

```{r}
library(cowplot)

nectar_combined_plot <- plot_grid(nectar_total_plot, residuals_nectar_total_plot, nectar_day_1_plot, residuals_nectar_day_1_plot, labels = c("a", "b", "c", "d"), label_size = 12, ncol = 2, rel_widths = c(2, 1), label_x = 0, label_y = 0.85, hjust = -3.7, vjust = -1.5, align = "v")

# now add the title
title <- ggdraw() + 
  draw_label(
    "Degradation Models For FPF Residue Measurements In Honeybee Foraged Nectar",
    fontface = 'bold',
    size = 12,
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

combined_plots <- plot_grid(
  title, nectar_combined_plot,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

nectar_total_inset <- ggdraw(nectar_total_plot + theme_half_open(12)) +
  draw_plot(residuals_nectar_total_plot, .45, .45, .45, .45) +
  draw_plot_label(
    c("A", "B"),
    c(0.04, 0.48),
    c(1, 0.95),
    size = 12
  )

nectar_24_inset <- ggdraw(nectar_day_1_plot + theme_half_open(12)) +
  draw_plot(residuals_nectar_day_1_plot, .45, .45, .45, .45) +
  draw_plot_label(
    c("C", "D"),
    c(0.04, 0.48),
    c(1, 0.95),
    size = 12
  )

nectar_combined_inset_plot <- plot_grid(nectar_total_inset, nectar_24_inset, labels = c("", ""), ncol = 2, align = "v")

combined_plots

nectar_total_inset # if i want to use have to add x axis label, also sort out axis and title so none are bold

nectar_24_inset # if i want to use have to add x axis label, also sort out axis and title so none are bold
```

```{r}
# pollen cowplot
pollen_combined_plot <- plot_grid(pollen_total_plot, pollen_day_1_plot, labels = c("a", "b"), label_size = 12, ncol = 2, label_x = 0, label_y = 0.85, hjust = -3.7, vjust = -1.5, align = "v")


# now add the title
title <- ggdraw() + 
  draw_label(
    "Degradation Models For FPF Residue Measurements In Honeybee Foraged Pollen",
    fontface = 'bold',
    size = 12,
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

pollen_combined_plots <- plot_grid(
  title, pollen_combined_plot,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

pollen_combined_plots

# create inset plot where only data past 23h is plotted
# degradation plot for >=24h
pollen_day_1_plot_reduced_data <- degradation_plot_function(dataframe = pollen_day_24, model_prediction = sfo_line_24, input_colour = colour, x_min_line = 24, title = expression(paste("Reduced Dataset (>23h) - SFO  ", chi, "2 Error Level = 138%")))

# add more conservative exposure regime onto plot
pollen_day_1_plot_reduced_data <- pollen_day_1_plot_reduced_data + geom_segment(aes(x=0,xend=24,y=pollen_mean_24h,yend=pollen_mean_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

pollen_day_1_plot_reduced_data <- pollen_day_1_plot_reduced_data + geom_segment(aes(x=24,xend=240,y=pollen_mean_post_24h,yend=pollen_mean_post_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

pollen_day_1_plot_reduced_data <- pollen_day_1_plot_reduced_data + geom_segment(aes(x=24,xend=24,y=pollen_mean_24h,yend=pollen_mean_post_24h), inherit.aes = FALSE, color = colour_lines, alpha = 0.7, data = data.frame())

pollen_day_1_plot_reduced_data <- pollen_day_1_plot_reduced_data + theme(axis.title.y = element_blank())

pollen_combined_plot_reduced_data <- plot_grid(pollen_total_plot, pollen_day_1_plot_reduced_data, labels = c("a", "b"), label_size = 12, ncol = 2, label_x = 0, label_y = 0.85, hjust = -3.7, vjust = -1.5, align = "v")

pollen_combined_plot_reduced_data <- plot_grid(
                                              title, pollen_combined_plot_reduced_data,
                                              ncol = 1,
                                              # rel_heights values control vertical title margins
                                              rel_heights = c(0.1, 1)
                                              )

pollen_combined_plot_reduced_data
```


```{r}
# save
 cairo_pdf(file = "./combined_plots_nectar.pdf",   # The directory you want to save the file in
     width = 8, # The width of the plot in inches
     height = 6) # The height of the plot in inches

combined_plots

 dev.off()
 
  cairo_pdf(file = "./combined_plots_pollen.pdf",   # The directory you want to save the file in
     width = 8, # The width of the plot in inches
     height = 6) # The height of the plot in inches

pollen_combined_plot_reduced_data

 dev.off()
```

